{% load i18n %}
{% load static tailwind_tags %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE|default:'ko' }}">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>{% block title %}{% endblock %}</title>
  {% block additional_head %}{% endblock %}

  <!-- favicon (기존 코드 유지) -->
  <link rel="icon" type="image/svg+xml" href="{% static 'img/mikihands-favicon.svg' %}">
  <link rel="icon" sizes="16x16" href="{% static 'img/mikihands-favicon-16.png' %}" type="image/png">
  <link rel="icon" sizes="32x32" href="{% static 'img/mikihands-favicon-32.png' %}" type="image/png">
  <link rel="icon" sizes="48x48" href="{% static 'img/mikihands-favicon-48.png' %}" type="image/png">
  <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/mikihands-favicon-180.png' %}">

  <!-- Fonts (기존 스타일 유지: Inter + Noto Sans KR) -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet" />

  {% if not DEBUG_MODE %}{% tailwind_preload_css %}{% endif %}
  {% tailwind_css %}
  <style>
    body { font-family: Inter, 'Noto Sans KR', system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Apple SD Gothic Neo', 'Nanum Gothic', 'Malgun Gothic', sans-serif; }
  </style>
</head>
<body class="min-h-screen bg-white text-slate-900">
  <!-- Header -->
  <header class="sticky top-0 z-30 backdrop-blur bg-white/80 border-b border-slate-100">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <!-- Brand -->
      <a href="{% url 'mybook:upload_page' %}" class="group inline-flex items-center gap-2" aria-label="BookWeaver">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-md bg-blue-600 text-white font-extrabold tracking-tight">W</span>
        <span class="text-slate-800 text-lg font-semibold tracking-tight group-hover:opacity-90">Weaver</span>
      </a>

      <!-- Nav -->
      <nav class="flex items-center gap-4 md:gap-8 text-sm font-medium">
        <div class="hidden md:flex px-3 items-center gap-4">
            <a href="{% url 'mybook:features' %}" class="hover:text-blue-600">{% trans "기능" %}</a>
            <a href="{% url 'mybook:pricing' %}" class="hover:text-blue-600">{% trans "가격" %}</a>
            <!-- FAQ: 백엔드에 mybook:faq 추가 필요 -->
            <a href="{% url 'mybook:faq' %}" class="hover:text-blue-600">FAQ</a>
        </div>
        {% if user_logged_in %}
          <a href="{% url 'mybook:bookshelf' %}" class="hidden sm:inline-block rounded-lg bg-gray-100 px-3 py-1.5 hover:bg-gray-200">{% trans "내 서재" %}</a>
        {% endif %}
        <!-- Right actions (login state) -->
        {% if user_logged_in %}
            <div class="relative">
                <button id="user-menu-button" class="flex items-center gap-2 px-3 py-1.5 text-sm font-medium">
                    <span>{{ user_profile.username }}</span>
                    <svg class="w-4 h-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.19l3.71-3.96a.75.75 0 111.08 1.04l-4.25 4.55a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/></svg>
                </button>
                <div id="user-menu" class="hidden absolute right-0 mt-2 w-40 bg-white border border-slate-200 rounded-md shadow-lg py-1 z-50">
                    <a href="{% url 'mybook:bookshelf' %}" class="block sm:hidden px-3 py-2 text-sm text-slate-700 text-center hover:bg-slate-50">{% trans "내 서재" %}</a>
                    <a href="{% url 'mybook:profile' %}" class="block px-3 py-2 text-sm text-slate-700 text-center hover:bg-slate-50">{% trans "계정관리" %}</a>
                    <a href="{% url 'mybook:logout' %}" class="block px-3 py-2 text-sm text-slate-700 text-center hover:bg-slate-50">{% trans "로그아웃" %}</a>
                </div>
            </div>
        {% else %}
            <div class="flex items-center gap-3">
            <a href="{% url 'mybook:login_page' %}" class="sm:inline-block text-sm font-medium text-slate-700 hover:text-slate-900">{% trans "로그인" %}</a>
            <a href="{% url 'mybook:register_page' %}" class="inline-flex items-center rounded-md bg-blue-600 text-white px-3 py-1.5 text-sm font-semibold hover:bg-blue-700">{% trans "무료로 시작" %}</a>
            </div>
        {% endif %}
      </nav>
    </div>
  </header>

  <!-- Page content -->
  <main>
    {% block content %}{% endblock %}
  </main>

  <!-- Global Message Modal -->
  <div id="messageModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-sm shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <div id="modalIcon" class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100">
          <!-- Icon will be set by JS -->
        </div>
        <h3 class="text-lg leading-6 font-medium text-gray-900 mt-2" id="modalTitle"></h3>
        <div class="mt-2 px-7 py-3">
          <p class="text-sm text-gray-500" id="modalMessage"></p>
        </div>
        <div id="modalButtons" class="items-center px-4 py-3 flex flex-col-reverse sm:flex-row-reverse gap-2">
          <button id="modalConfirmBtn" class="hidden w-full sm:w-auto px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md shadow-sm hover:bg-blue-700">
            {% trans "확인" %}
          </button>
          <button id="modalCloseBtn" class="w-full sm:w-auto px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md shadow-sm hover:bg-gray-300">
            {% trans "닫기" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <template id="icon-template-info">
    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
  </template>
  <template id="icon-template-success">
    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
  </template>
  <template id="icon-template-warning">
    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
  </template>

    {# 현재 언어/지원 언어 목록 얻기 #}
{% get_current_language as CURRENT_LANGUAGE_CODE %}
{% get_available_languages as LANGUAGES %}
{% get_language_info_list for LANGUAGES as languages %}

  <!-- Footer (기존 항목 구성 유지: 약관/개인정보/문의/언어선택) -->
  <!-- Footer -->
<footer class="mt-10 border-t border-slate-200/70 bg-white/70 backdrop-blur mt-auto">
  <div class="mx-auto max-w-7xl px-6 py-8 flex flex-col sm:flex-row items-center justify-between gap-4">
    <p class="text-sm text-slate-500">© <span id="y"></span> Mikihands · BookWeaver</p>

    <div class="flex items-center gap-4">
      <!-- Footer nav -->
      <nav class="flex items-center gap-4 text-sm text-slate-600">
        <a href="{% url 'mybook:terms' %}" class="hover:text-slate-800">{% trans "이용 약관" %}</a>
        <a href="{% url 'mybook:privacy' %}" class="hover:text-slate-800">{% trans "개인정보 처리방침" %}</a>
        <a href="{% url 'mybook:contact' %}" class="hover:text-slate-800">{% trans "문의" %}</a>
      </nav>

      <!-- Language selector (no-JS dropdown) -->
      <details class="relative">
        <summary class="list-none inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-50 cursor-pointer">
          <span class="text-base" aria-hidden="true">
            {# 간단한 국기 이모지 매핑 (필요 언어만 if로 확장) #}
            {% if CURRENT_LANGUAGE_CODE|slice:":2" == "ko" %}🇰🇷{% elif CURRENT_LANGUAGE_CODE|slice:":2" == "en" %}🇺🇸{% elif CURRENT_LANGUAGE_CODE|slice:":2" == "ja" %}🇯🇵{% elif CURRENT_LANGUAGE_CODE|slice:":2" == "zh" %}🇨🇳{% elif CURRENT_LANGUAGE_CODE|slice:":2" == "de" %}🇩🇪{% elif CURRENT_LANGUAGE_CODE|slice:":2" == "fr" %}🇫🇷{% elif CURRENT_LANGUAGE_CODE|slice:":2" == "es" %}🇪🇸{% else %}🌐{% endif %}
          </span>
          <span class="sr-only">{% trans "언어 선택" %}</span>
          <span class="uppercase">{{ CURRENT_LANGUAGE_CODE }}</span>
          <svg class="h-4 w-4 text-slate-400" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.2l3.71-3.97a.75.75 0 111.08 1.04l-4.25 4.55a.75.75 0 01-1.08 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
          </svg>
        </summary>

        <div class="absolute bottom-full right-0 mb-2 w-56 rounded-xl border border-slate-200 bg-white shadow-lg p-2 z-50">
          {% for lang in languages %}
            <form method="post" action="{% url 'set_language' %}" class="w-full">
              {% csrf_token %}
              <input type="hidden" name="next" value="{{ request.get_full_path }}">
              <input type="hidden" name="language" value="{{ lang.code }}">
              <button type="submit"
                      class="w-full flex items-center justify-between gap-3 rounded-lg px-3 py-2 text-sm hover:bg-slate-50 {% if lang.code == CURRENT_LANGUAGE_CODE %}text-slate-900 font-semibold{% else %}text-slate-700{% endif %}">
                <span class="inline-flex items-center gap-2">
                  <span aria-hidden="true">
                    {% if lang.code|slice:":2" == "ko" %}🇰🇷{% elif lang.code|slice:":2" == "en" %}🇺🇸{% elif lang.code|slice:":2" == "ja" %}🇯🇵{% elif lang.code|slice:":2" == "zh" %}🇨🇳{% elif lang.code|slice:":2" == "de" %}🇩🇪{% elif lang.code|slice:":2" == "fr" %}🇫🇷{% elif lang.code|slice:":2" == "es" %}🇪🇸{% else %}🌐{% endif %}
                  </span>
                  <span>{{ lang.name_local }}</span>
                </span>
                {% if lang.code == CURRENT_LANGUAGE_CODE %}
                  <span class="text-indigo-600">•</span>
                {% endif %}
              </button>
            </form>
          {% endfor %}
        </div>
      </details>
    </div>
  </div>
</footer>

  <script>
    // year
    document.getElementById('y').textContent = new Date().getFullYear();

    // user dropdown
    const btn = document.getElementById('user-menu-button');
    const menu = document.getElementById('user-menu');
    if (btn && menu) {
      btn.addEventListener('click', () => menu.classList.toggle('hidden'));
      window.addEventListener('click', (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) menu.classList.add('hidden');
      });
    }

    // --- Global Modal Manager ---
    class ModalManager {
        constructor() {
            this.modal = document.getElementById('messageModal');
            this.title = document.getElementById('modalTitle');
            this.message = document.getElementById('modalMessage');
            this.iconContainer = document.getElementById('modalIcon');
            this.closeBtn = document.getElementById('modalCloseBtn');
            this.confirmBtn = document.getElementById('modalConfirmBtn');

            this.closeBtn.addEventListener('click', () => this.hide());
            this.confirmCallback = null;

            this.icons = {
                info: document.getElementById('icon-template-info').innerHTML,
                success: document.getElementById('icon-template-success').innerHTML,
                warning: document.getElementById('icon-template-warning').innerHTML,
            };
            this.iconColors = {
                info: 'bg-blue-100',
                success: 'bg-green-100',
                warning: 'bg-yellow-100',
            };
        }

        _setIcon(type) {
            this.iconContainer.innerHTML = this.icons[type] || this.icons.info;
            this.iconContainer.className = `mx-auto flex items-center justify-center h-12 w-12 rounded-full ${this.iconColors[type] || this.iconColors.info}`;
        }

        showAlert(title, message, type = 'info') {
            this.title.textContent = title;
            this.message.innerHTML = message;
            this._setIcon(type);
            this.confirmBtn.classList.add('hidden');
            this.modal.classList.remove('hidden');
        }

        showConfirm(title, message, onConfirm, type = 'warning') {
            this.title.textContent = title;
            this.message.innerHTML = message;
            this._setIcon(type);
            this.confirmBtn.classList.remove('hidden');
            this.modal.classList.remove('hidden');
            
            this.confirmCallback = onConfirm;
            this.confirmBtn.onclick = () => {
                this.hide();
                if (this.confirmCallback) this.confirmCallback();
            };
        }

        hide() {
            this.modal.classList.add('hidden');
        }
    }
    const modalManager = new ModalManager();
  </script>
  {% block extra_js %}{% endblock %}
</body>
</html>
