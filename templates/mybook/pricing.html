{% extends 'base.html' %}
{% load i18n my_filters %}
{% block title %}Weaver — Pricing{% endblock %}

{% block content %}
<section class="mx-auto max-w-7xl px-6 py-14 md:py-20 text-center">
  <h1 class="text-3xl md:text-5xl font-extrabold">{% trans "간단하고 투명한 가격" %}</h1>
  <p class="mt-4 text-lg text-slate-600">{% trans "Eco는 페이지당 1, Precision은 페이지당 6 크레딧 차감(복잡도 가중). 필요한 경우 크레딧으로 확장하세요." %}</p>
  <p class="mt-2 text-sm text-slate-500">{% trans "Pro/Enterprise 연간 구독 전환 시 1개월 무료." %}</p>
</section>

<section class="border-t border-slate-100">
  {% if user.is_authenticated and user.is_paid_member and not user.cancel_requested %}
    {% define_plan_levels as plan_levels %}
    {% get_plan_level user.plan_type as user_plan_level %}
  {% else %}
    {% define_plan_levels as plan_levels %}
    {% get_plan_level 'None' as user_plan_level %}
  {% endif %}
  <div class="mx-auto max-w-7xl px-6 py-12 grid md:grid-cols-4 gap-6">
    <!-- Starter -->
    <div class="rounded-2xl border border-slate-200 p-6 flex flex-col">
      <h3 class="font-bold text-lg">Starter</h3>
      {% if LANGUAGE_CODE == 'ko' %}
        <p class="mt-1 text-3xl font-extrabold">₩6,000<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% else %}
        <p class="mt-1 text-3xl font-extrabold">$4<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% endif %}
      <ul class="mt-4 space-y-2 text-sm text-slate-700">
        <li>Eco {% trans "월" %} 1,000 p</li>
        <li>Precision 최대 100 p</li>
        <li>PDF {% trans "다운로드 가능" %}</li>
        <li>{% trans "보관 제한 해제" %}</li>
      </ul>
      {% if user.is_authenticated and user.is_paid_member and not user.cancel_requested %}
        {% if plan_levels.Starter > user_plan_level %}
          <button data-plan="Starter" class="upgrade-btn mt-auto block text-center rounded-lg bg-green-600 text-white py-3 font-semibold hover:bg-green-700">{% trans "업그레이드" %}</button>
        {% else %}
          <button disabled class="mt-auto block text-center rounded-lg bg-slate-300 text-slate-500 py-3 font-semibold cursor-not-allowed">{% if plan_levels.Starter == user_plan_level %}{% trans "현재 플랜" %}{% else %}{% trans "업그레이드 불가" %}{% endif %}</button>
        {% endif %}
      {% else %}
        <button data-plan="Starter" class="subscribe-btn mt-auto block text-center rounded-lg bg-blue-600 text-white py-3 font-semibold hover:bg-blue-700">{% trans "시작하기" %}</button>
      {% endif %}
    </div>
    <!-- Growth -->
    <div class="rounded-2xl border border-slate-200 p-6 flex flex-col">
      <h3 class="font-bold text-lg">Growth</h3>
      {% if LANGUAGE_CODE == 'ko' %}
        <p class="mt-1 text-3xl font-extrabold">₩10,500<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% else %}
        <p class="mt-1 text-3xl font-extrabold">$7<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% endif %}
      <ul class="mt-4 space-y-2 text-sm text-slate-700">
        <li>Eco {% trans "월" %} 2,000 p</li>
        <li>Precision 최대 200 p</li>
        <li>PDF {% trans "다운로드 가능" %}</li>
        <li>{% trans "보관 제한 해제" %}</li>
      </ul>
      {% if user.is_authenticated and user.is_paid_member and not user.cancel_requested %}
        {% if plan_levels.Growth > user_plan_level %}
          <button data-plan="Growth" class="upgrade-btn mt-auto block text-center rounded-lg bg-green-600 text-white py-3 font-semibold hover:bg-green-700">{% trans "업그레이드" %}</button>
        {% else %}
          <button disabled class="mt-auto block text-center rounded-lg bg-slate-300 text-slate-500 py-3 font-semibold cursor-not-allowed">{% if plan_levels.Growth == user_plan_level %}{% trans "현재 플랜" %}{% else %}{% trans "업그레이드 불가" %}{% endif %}</button>
        {% endif %}
      {% else %}
        <button data-plan="Growth" class="subscribe-btn mt-auto block text-center rounded-lg bg-blue-600 text-white py-3 font-semibold hover:bg-blue-700">{% trans "시작하기" %}</button>
      {% endif %}
    </div>
    <!-- Pro -->
    <div class="rounded-2xl border-2 border-blue-600 p-6 relative flex flex-col">
      <div class="absolute -top-3 right-4 rounded-full bg-blue-600 text-white text-xs px-3 py-1">{% trans "Most Popular" %}</div>
      <h3 class="font-bold text-lg">Pro</h3>
      {% if LANGUAGE_CODE == 'ko' %}
        <p class="mt-1 text-3xl font-extrabold">₩22,500<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% else %}
        <p class="mt-1 text-3xl font-extrabold">$15<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% endif %}
      <ul class="mt-4 space-y-2 text-sm text-slate-700">
        <li>Eco {% trans "월" %} 5,000 p</li>
        <li>Precision 최대 500 p</li>
        <li>{% trans "문단 재번역 무료" %}</li>
        <li>PDF {% trans "다운로드, 보관 무제한" %}</li>
        <li>{% trans "연간 전환 시 1개월 무료" %}</li>
      </ul>
      {% if user.is_authenticated and user.is_paid_member and not user.cancel_requested %}
        {% if plan_levels.Pro > user_plan_level %}
          <button data-plan="Pro" class="upgrade-btn mt-auto block text-center rounded-lg bg-green-600 text-white py-3 font-semibold hover:bg-green-700">{% trans "업그레이드" %}</button>
        {% else %}
          <button disabled class="mt-auto block text-center rounded-lg bg-slate-300 text-slate-500 py-3 font-semibold cursor-not-allowed">{% if plan_levels.Pro == user_plan_level %}{% trans "현재 플랜" %}{% else %}{% trans "업그레이드 불가" %}{% endif %}</button>
        {% endif %}
      {% else %}
        <button data-plan="Pro" class="subscribe-btn mt-auto block text-center rounded-lg bg-blue-600 text-white py-3 font-semibold hover:bg-blue-700">{% trans "시작하기" %}</button>
      {% endif %}
    </div>
    <!-- Enterprise -->
    <div class="rounded-2xl border border-slate-200 p-6 flex flex-col">
      <h3 class="font-bold text-lg">Enterprise</h3>
      {% if LANGUAGE_CODE == 'ko' %}
        <p class="mt-1 text-3xl font-extrabold">₩37,500<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% else %}
        <p class="mt-1 text-3xl font-extrabold">$25<span class="text-sm font-medium text-slate-500"> /{% trans "월" %}</span></p>
      {% endif %}
      <ul class="mt-4 space-y-2 text-sm text-slate-700">
        <li>Eco {% trans "월" %} 10,000 p</li>
        <li>Precision 최대 1,000 p</li>
        <li>{% trans "문단 재번역 무료" %}</li>
        <li>PDF {% trans "다운로드, 보관 무제한" %}</li>
        <li>SLA 99.5% {% trans "목표 + 서비스 크레딧" %}</li>
        <li>{% trans "연간 전환 시 1개월 무료" %}</li>
      </ul>
      {% if user.is_authenticated and user.is_paid_member and not user.cancel_requested %}
        {% if plan_levels.Enterprise > user_plan_level %}
          <button data-plan="Enterprise" class="upgrade-btn mt-auto block text-center rounded-lg bg-green-600 text-white py-3 font-semibold hover:bg-green-700">{% trans "업그레이드" %}</button>
        {% else %}
          <button disabled class="mt-auto block text-center rounded-lg bg-slate-300 text-slate-500 py-3 font-semibold cursor-not-allowed">{% if plan_levels.Enterprise == user_plan_level %}{% trans "현재 플랜" %}{% else %}{% trans "업그레이드 불가" %}{% endif %}</button>
        {% endif %}
      {% else %}
        <button data-plan="Enterprise" class="subscribe-btn mt-auto block text-center rounded-lg bg-blue-600 text-white py-3 font-semibold hover:bg-blue-700">{% trans "시작하기" %}</button>
      {% endif %}
    </div>
  </div>

  <p class="mx-auto max-w-7xl px-6 mt-4 text-sm text-slate-500">{% trans "차감 규칙:" %} <strong>Eco 1p = 1</strong> · <strong>Precision 1p = 6</strong></p>
</section>

<section class="border-t border-slate-100 bg-slate-50/50">
  <div class="mx-auto max-w-7xl px-6 py-14 md:flex items-start gap-10">
    <div class="md:w-1/2">
      <h2 class="text-2xl md:text-3xl font-extrabold">{% trans "한도 초과 시, 크레딧으로 확장" %}</h2>
      <p class="mt-3 text-slate-600">{% trans "보유 플랜의 월간 페이지 한도를 모두 사용해도 크레딧으로 이어서 번역할 수 있습니다." %}</p>
      <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-6">
        <h3 class="font-semibold">{% trans "크레딧(Credit)이란?" %}</h3>
        <ul class="mt-3 text-sm text-slate-700 space-y-2">
          <li>{% trans "정의: Eco 1p = 1크레딧, Precision 1p = 6크레딧" %}</li> 
          {% if LANGUAGE_CODE == 'ko' %}
            <li>{% trans "가격: ₩7,500 / 1,000 크레딧 (1,000 단위로 구매)" %}</li>
          {% else %}
            <li>{% trans "가격: $5 / 1,000 크레딧 (1,000 단위로 구매)" %}</li>
          {% endif %}
          <li>{% trans "유효기간: 구매일로부터 1년 (미사용 소멸)" %}</li>
          <li>{% trans "사용 규칙: 월 한도 미초과 시 크레딧은 사용되지 않음, 초과 시 사용" %}</li>
        </ul>
        <div class="mt-4 rounded-lg bg-blue-50 text-blue-900 text-sm p-4">
          <p class="font-semibold">{% trans "예시" %}</p>
          <p class="mt-1">{% blocktrans %}Growth(월 2,000p) 사용자가 Eco 500p + Precision 200p를 사용했다면, 잔여는 <strong>300p</strong> (2,000 − (500 + 200×6)). Precision을 더 사용하려면 크레딧이 필요합니다.{% endblocktrans %}</p>
        </div>
      </div>
    </div>
    <div class="md:w-1/2 mt-10 md:mt-0">
      <h3 class="font-semibold text-lg">{% trans "공통 혜택" %}</h3>
      <ul class="mt-3 text-sm text-slate-700 space-y-2">
        <li>{% trans "무료: 문서당 30페이지, 결과 확인/편집, 5권 보관, 원문 비교" %}</li>
        <li>{% trans "유료 공통: PDF 다운로드, 원본 페이지 제한 없음, 보관 무제한" %}</li>
        <li>{% trans "Pro/Enterprise: 문단 재번역 무료, 연간 전환 1개월 무료, PDF 편집기(예정)" %}</li>
      </ul>

      <h3 class="font-semibold text-lg mt-8">{% trans "결제 & 세금" %}</h3>
      <ul class="mt-3 text-sm text-slate-700 space-y-2">
        <li>{% trans "대한민국: 부가가치세 10% 부과" %}</li>
        <li>{% trans "해외 비거주자: 요건 충족 시 영세율(0%)" %}</li>
        <li>{% trans "대한민국 결제: 토스페이먼츠, 해외 결제: PayPal(국내 사용자는 PayPal 불가)" %}</li>
      </ul>

      <div class="mt-8">
        <a href="{% url 'mybook:faq' %}#policy" class="inline-flex items-center gap-2 text-blue-600 font-semibold hover:underline">
          {% trans "SLA/환불/데이터/저작권 등 정책 자세히 보기" %}<svg class="w-4 h-4" viewBox="0 0 24 24"><path d="M9 5l7 7-7 7" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </a>
      </div>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const subscribeButtons = document.querySelectorAll('.subscribe-btn');
    const upgradeButtons = document.querySelectorAll('.upgrade-btn');

    subscribeButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
            const planType = e.target.dataset.plan;
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            try {
                const response = await fetch("{% url 'mybook_api:create_subscription' %}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                    body: JSON.stringify({ plan_type: planType })
                });

                const data = await response.json();

                if (response.ok && data.approval_url) { // PayPal의 경우: 받은 URL로 이동
                    window.location.href = data.approval_url;
                } 
                else {
                    const errorMessage = data.error || '{% trans "알 수 없는 오류가 발생했습니다." %}';
                    if (response.status === 403) {
                        modalManager.showAlert('{% trans "로그인 필요" %}', '{% trans "결제를 진행하려면 먼저 로그인해야 합니다." %} <a href="{% url 'mybook:login_page' %}" class="text-blue-600 hover:underline">{% trans "로그인 페이지로 이동" %}</a>', 'warning');
                    } else {
                        modalManager.showAlert('{% trans "오류" %}', errorMessage, 'warning');
                    }
                }
            } catch (error) {
                modalManager.showAlert('{% trans "네트워크 오류" %}', '{% trans "서버와 통신할 수 없습니다. 잠시 후 다시 시도해주세요." %}', 'warning');
            }
        });
    });

    upgradeButtons.forEach(button => {
        button.addEventListener('click', async (e) => {
            const newPlan = e.target.dataset.plan;
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            modalManager.showConfirm(
                `'${newPlan}' {% trans "플랜으로 업그레이드" %}`,
                '{% trans "남은 구독 기간에 대한 차액이 결제됩니다. 계속하시겠습니까?" %}',
                async () => {
                    try {
                        const response = await fetch("{% url 'mybook_api:upgrade_subscription' %}", {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                            body: JSON.stringify({ new_plan: newPlan })
                        });
                        const data = await response.json();

                        if (response.ok && data.payment_approval_url) { // PayPal
                            window.location.href = data.payment_approval_url;
                        } else if (response.ok && data.upgraded) { // Toss Payments
                            modalManager.showAlert('{% trans "업그레이드 완료" %}', data.message, 'success');
                            document.getElementById('modalCloseBtn').onclick = () => window.location.reload();
                        } else {
                            const errorMessage = data.error || '{% trans "알 수 없는 오류가 발생했습니다." %}';
                            modalManager.showAlert('{% trans "업그레이드 오류" %}', errorMessage, 'warning');
                        }
                    } catch (error) {
                        modalManager.showAlert('{% trans "네트워크 오류" %}', '{% trans "서버와 통신할 수 없습니다. 잠시 후 다시 시도해주세요." %}', 'warning');
                    }
                }
            );
        });
    });
});
</script>
{% endblock %}
