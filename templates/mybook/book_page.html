{% extends "page_base.html" %}
{% load static tailwind_tags %}
{% load weaver_extras %}
{% block title %} {{ book.title }} - p{{ page_no }} {% endblock %}

{% block additional_head %}
<style>
  :root { --bg:#f9fafb; --ink:#111827; --muted:#6b7280; --top-margin: {{ css_vars|dict_get:'--top-margin' }}; }
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;}

  .wrap{max-width:100vw;margin:0 auto;padding:16px;}
  .toolbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:10px;flex-wrap:wrap}
  .toolbar .group{display:flex;gap:8px;align-items:center}
  .toolbar button, .toolbar select{
    font:inherit;padding:6px 10px;border:1px solid #e5e7eb;border-radius:8px;background:#fff;cursor:pointer}
  .toolbar button:hover{background:#f3f4f6}

  .stage{
    position:relative;
    overflow:auto;
    max-height: calc(100vh - 140px);
    display: flex;
    justify-content: center;
    align-items: flex-start; /* 페이지를 상단에 정렬 */
    padding: 20px 0; /* 뷰어의 상하 여백 */
  }
  .page-viewport {
    background: white;
    border: 1px solid #e5e7eb;
    border-radius: 12px;
    box-shadow: 0 8px 24px rgba(0,0,0,.06);
    padding: 12px;
    box-sizing: border-box; /* padding을 너비/높이에 포함 */
    flex-shrink: 0; /* flex 아이템이 줄어들지 않도록 설정 */
  }

  .page{
    position:relative;
    width:{{ page_w }}px;
    height:{{ page_h }}px;
    {% if background_url %}
      background-image:url('{{ background_url }}'); background-size:contain; background-repeat:no-repeat; background-position:center;
    {% endif %}
    transform-origin: top left;
  }

  /* v2 HTML stage 내부 기본 타이포 */
  .page :is(p,li){line-height:1.5}
  figure{margin:0.5rem 0;display:flex;flex-direction:column}
  figure img{max-width:100%;height:auto;border:1px solid #e5e7eb;border-radius:6px;background:#fff}
  figure figcaption{margin-top:.4rem;font-size:.9rem;color:var(--muted)}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #e5e7eb;padding:.5rem;vertical-align:top}

  .content div, .content p, .content div p {
      line-height: var(--leading);  
      margin-bottom: var(--para-gap);
  }
  .content {
    
    font-size: var(--font-base);
    padding: var(--pad);
    width: var(--content-w);
    height: var(--content-h);
    margin: 0 auto;
    padding-top: var(--top-margin);
  }
    
</style>
{% endblock %}

{% block content %}
<div class="content" 
    style="
    --font-base: {{ css_vars|dict_get:'--font-base' }};
    --leading: {{ css_vars|dict_get:'--leading' }};
    --para-gap: {{ css_vars|dict_get:'--para-gap' }};
    --content-w: {{ css_vars|dict_get:'--content-w' }};
    --content-h: {{ css_vars|dict_get:'--content-h' }};
    --pad: {{ css_vars|dict_get:'--pad' }};
">
  {{ html_stage_final|safe }}
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const pageW = {{ page_w|default:800 }};
  const pageH = {{ page_h|default:1200 }};
  const stage  = document.getElementById('stage');
  if (!stage) return;
  const vp    = document.getElementById('pageViewport');
  const page   = document.getElementById('page');
  const zoomLabel = document.getElementById('zoomLabel');
  const fitWBtn = document.getElementById('fitW');
  const fitHBtn = document.getElementById('fitH');
  const zoomIn  = document.getElementById('zoomIn');
  const zoomOut = document.getElementById('zoomOut');
  const bgModeSel = document.getElementById('bgMode');

  const params = new URLSearchParams(location.search);
  bgModeSel.addEventListener('change', ()=>{
    const p = new URLSearchParams(location.search);
    p.set('bg', bgModeSel.value);
    location.search = p.toString();
  });

  let scale = 1.0;
  let zoomMode = 'fitWidth'; // 'fitWidth', 'fitHeight', 'custom' 중 하나를 저장
  const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
  const ZOOM_STATE_KEY = 'weaver_zoom_state'; // localStorage에 저장될 키

  // 현재 확대/축소 상태(비율과 모드)를 저장하는 함수
  function saveZoomState() {
    const state = { scale: scale, mode: zoomMode };
    localStorage.setItem(ZOOM_STATE_KEY, JSON.stringify(state));
  }

  function applyScale(newScale) {
    scale = clamp(newScale, 0.2, 3);
    page.style.transform = `scale(${scale})`;
    zoomLabel.textContent = Math.round(scale*100) + '%';

    const viewportPadding = 24;
    const scaledW = pageW * scale;
    const scaledH = pageH * scale;

    vp.style.width  = (scaledW + viewportPadding) + 'px';
    vp.style.height = (scaledH + viewportPadding) + 'px';
    stage.style.height = (scaledH + viewportPadding) + 'px';

    // 스케일이 적용될 때마다 상태를 저장합니다.
    saveZoomState();
  }
  
  function fitWidth(){
    zoomMode = 'fitWidth';
    const viewportPadding = 24;
    const availableWidth = stage.clientWidth;
    applyScale((availableWidth - viewportPadding) / pageW);
  }
  function fitHeight(){
    zoomMode = 'fitHeight';
    const pad = 24*2;
    const avail = (window.innerHeight - stage.getBoundingClientRect().top - 40) - pad;
    applyScale(avail / pageH);
  }

  fitWBtn.addEventListener('click', fitWidth);
  fitHBtn.addEventListener('click', fitHeight);
  zoomIn.addEventListener('click', () => {
    zoomMode = 'custom'; // 사용자가 직접 조절했음을 표시
    applyScale(scale * 1.1);
  });
  zoomOut.addEventListener('click', () => {
    zoomMode = 'custom'; // 사용자가 직접 조절했음을 표시
    applyScale(scale / 1.1);
  });
  window.addEventListener('resize', () => {
    // '가로 맞춤' 상태일 때만 창 크기 변경에 따라 너비를 다시 맞춥니다.
    if (zoomMode === 'fitWidth') {
      fitWidth();
    }
  });

  // 초기 뷰 설정: 저장된 확대/축소 상태가 있으면 복원합니다.
  (function initializeView() {
    try {
      const savedStateJSON = localStorage.getItem(ZOOM_STATE_KEY);
      if (savedStateJSON) {
          const savedState = JSON.parse(savedStateJSON);
          if (savedState && savedState.mode) {
              zoomMode = savedState.mode;
              if (zoomMode === 'fitWidth') { fitWidth(); return; }
              if (zoomMode === 'fitHeight') { fitHeight(); return; }
              if (zoomMode === 'custom' && typeof savedState.scale === 'number') { applyScale(savedState.scale); return; }
          }
      }
    } catch (e) {
      console.error("Failed to restore zoom state, using default.", e);
      localStorage.removeItem(ZOOM_STATE_KEY); // 손상된 데이터 제거
    }
    // 저장된 상태가 없거나 유효하지 않으면 기본값으로 시작합니다.
    fitWidth();
  })();
})();
</script>
{% endblock %}
