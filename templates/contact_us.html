{% extends "base.html" %}
{% load i18n static tailwind_tags %}

{% block title %}Weaver · {% trans "문의" %}{% endblock %}

{% block additional_head %}
<script>
  // CSRF 토큰 (SessionAuthentication용)
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
</script>
{% endblock %}

{% block content %}
<section class="bg-white">
  <div class="mx-auto max-w-3xl px-4 py-12">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-extrabold text-slate-900">{% trans "문의하기" %}</h1>
      <p class="mt-2 text-slate-600">
        {% trans "문의 사항은 아래 양식을 작성해 주세요." %}
      </p>
    </div>

    <form id="contactForm" class="space-y-6 rounded-2xl border border-slate-200 bg-white p-6 shadow-sm" novalidate>
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
        <div class="flex flex-col space-y-2">
          <label for="name" class="text-gray-700 font-medium">{% trans "이름" %}</label>
          <input id="name" name="name" type="text" required
                 class="px-4 py-2 block w-full border border-gray-300 rounded-md {% if user_logged_in and user_profile %}bg-gray-100 cursor-not-allowed{% else %}focus:ring-blue-500 focus:border-blue-500{% endif %}"
                 {% if user_logged_in and user_profile %}value="{{ user_profile.username }}" readonly{% endif %} />
        </div>
        <div class="flex flex-col space-y-2">
          <label for="email" class="text-gray-700 font-medium">{% trans "이메일" %}</label>
          <input id="email" name="email" type="email" required
                 class="px-4 py-2 block w-full border border-gray-300 rounded-md {% if user_logged_in and user_profile %}bg-gray-100 cursor-not-allowed{% else %}focus:ring-blue-500 focus:border-blue-500{% endif %}"
                 {% if user_logged_in and user_profile %}value="{{ user_profile.email }}" readonly{% endif %} />
        </div>
      </div>

      <div class="flex flex-col space-y-2">
        <label for="subject" class="text-gray-700 font-medium">{% trans "제목" %}</label>
        <input id="subject" name="subject" type="text" required
               class="px-4 py-2 block w-full border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500" />
      </div>

      <div class="flex flex-col space-y-2">
        <label for="message" class="text-gray-700 font-medium">{% trans "메시지" %}</label>
        <textarea id="message" name="message" rows="7" required
                  class="px-4 py-2 block w-full border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"></textarea>
      </div>

      {# honeypot #}
      <div aria-hidden="true" style="position:absolute;left:-9999px;top:auto;width:1px;height:1px;overflow:hidden;">
        <label for="website">Website</label>
        <input id="website" name="website" type="text" tabindex="-1" autocomplete="off" />
      </div>

      <div class="flex items-center justify-end gap-3">
        <a href="{% url 'mybook:upload_page' %}" class="px-4 py-2 rounded-xl border border-slate-300 text-sm font-semibold text-slate-700 hover:bg-slate-50">{% trans "취소" %}</a>
        <button type="submit" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-500">
          {% trans "문의 보내기" %}
        </button>
      </div>
    </form>

    <!-- 결과 메시지 -->
    <div id="resultBox" class="hidden mt-4 rounded-md px-4 py-3 text-sm"></div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
  (function(){
    const form = document.getElementById('contactForm');
    const box  = document.getElementById('resultBox');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      box.className = 'hidden'; box.textContent = '';

      const payload = {
        name: form.name.value.trim(),
        email: form.email.value.trim(),
        subject: form.subject.value.trim(),
        message: form.message.value.trim(),
        website: form.website.value || '' // honeypot
      };

      try {
        const res = await fetch("{% url 'mybook:api_contact' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken') || '',
          },
          body: JSON.stringify(payload)
        });

        if (res.ok) {
          box.className = 'mt-4 rounded-md px-4 py-3 text-sm bg-green-50 text-green-700 border border-green-200';
          box.textContent = '{% trans "문의가 정상적으로 전송되었습니다. 가능한 빠르게 회신 드리겠습니다." %}';
          form.reset();
        } else {
          const data = await res.json().catch(()=>({}));
          box.className = 'mt-4 rounded-md px-4 py-3 text-sm bg-red-50 text-red-700 border border-red-200';
          box.textContent = (data && data.detail) ? data.detail : '{% trans "오류가 발생했습니다. 잠시 후 다시 시도해 주세요." %}';
        }
      } catch (err) {
        box.className = 'mt-4 rounded-md px-4 py-3 text-sm bg-red-50 text-red-700 border border-red-200';
        box.textContent = '{% trans "네트워크 오류가 발생했습니다. 인터넷 연결을 확인해 주세요." %}';
      }
    });
  })();
</script>
{% endblock %}