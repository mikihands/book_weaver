{% load static tailwind_tags i18n %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}BookWeaver - {% trans "ì–¸ì–´ì˜ ì¥ë²½ì„ ë„˜ì–´ ë” ë„“ì€ ì„¸ìƒìœ¼ë¡œ" %}{% endblock %}</title>
    {% block additional_head %}  {% endblock %}
    {# favicon #}
    <link rel="icon" type="image/svg+xml" href="{% static 'img/mikihands-favicon.svg' %}">
    <link rel="icon" sizes="16x16" href="{% static 'img/mikihands-favicon-16.png' %}" type="image/png">
    <link rel="icon" sizes="32x32" href="{% static 'img/mikihands-favicon-32.png' %}" type="image/png">
    <link rel="icon" sizes="48x48" href="{% static 'img/mikihands-favicon-48.png' %}" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/mikihands-favicon-180.png' %}">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
    </style>
    {% if not DEBUG_MODE %}
        {% tailwind_preload_css %}
    {% endif %}
    {% tailwind_css %}
</head>



<body>
    <nav class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <a href="{% url 'mybook:upload_page' %}" class="flex-shrink-0 flex items-center font-bold text-xl gap-2">
                        {% comment %} ğŸ“š BookWeaver {% endcomment %}
                        <span class="inline-flex h-8 w-8 items-center justify-center rounded-lg bg-slate-900 text-white">W</span>
                        <span class="text-slate-900">BookWeaver</span>
                    </a>
                </div>
                <div class="flex items-center">
                    {% if request.user.is_authenticated and request.user.username %}
                        <div class="relative ml-3">
                            <div>
                                <button type="button" id="user-menu-button-page" class="flex items-center text-gray-500 hover:text-gray-700 focus:outline-none rounded-md text-sm font-medium" aria-expanded="false" aria-haspopup="true">
                                    <span class="sr-only">Open user menu</span>
                                    <span>{{ request.user.username }} {% if LANGUAGE_CODE == 'ko' %}ë‹˜{% elif LANGUAGE_CODE == 'ja' %}æ§˜{% endif %}</span>
                                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </button>
                            </div>
                            <div id="user-menu-page" class="hidden origin-top-right absolute right-0 mt-2 w-48 rounded-md shadow-lg py-1 bg-white ring-1 ring-black ring-opacity-5 focus:outline-none z-50" role="menu" aria-orientation="vertical" aria-labelledby="user-menu-button-page">
                                <a href="{% url 'mybook:bookshelf' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">{% trans "ë‚´ ì„œì¬" %}</a>
                                <a href="{% url 'mybook:logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" role="menuitem">{% trans "ë¡œê·¸ì•„ì›ƒ" %}</a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'mybook:login_page' %}" class="text-gray-500 hover:text-gray-700 px-3 py-2 rounded-md text-sm font-medium">{% trans "ë¡œê·¸ì¸" %}</a>
                        <a href="{% url 'mybook:register_page' %}" class="ml-4 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700">
                            {% trans "íšŒì›ê°€ì…" %}
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>
    {# -- 1. ì‘ì—… ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ UI -- #}
    {% if book.status == 'failed' %}
    <div id="retry-banner" class="fixed top-20 right-5 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg shadow-lg z-50" role="alert">
      <strong class="font-bold">{% trans "ë²ˆì—­ ì‹¤íŒ¨!" %}</strong>
      <span class="block sm:inline">{% trans "ì¼ë¶€ í˜ì´ì§€ ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." %}</span>
      <button id="retry-book-button" class="mt-2 bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-3 rounded">
        {% trans "ì‹¤íŒ¨í•œ ì‘ì—… ì¬ì‹œë„" %}
      </button>
      <button onclick="document.getElementById('retry-banner').style.display='none'" class="absolute top-0 bottom-0 right-0 px-4 py-3">
        <svg class="fill-current h-6 w-6 text-red-500" role="button" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><title>Close</title><path d="M14.348 14.849a1.2 1.2 0 0 1-1.697 0L10 11.819l-2.651 3.029a1.2 1.2 0 1 1-1.697-1.697l2.758-3.15-2.759-3.152a1.2 1.2 0 1 1 1.697-1.697L10 8.183l2.651-3.031a1.2 1.2 0 1 1 1.697 1.697l-2.758 3.152 2.758 3.15a1.2 1.2 0 0 1 0 1.698z"/></svg>
      </button>
    </div>
    {% endif %}

    <div class="wrap" id="weaver-root" style="font-size: calc(1rem * {{ base_font_scale|default:1 }})">

    <div class="toolbar">
        <div class="group">
        {% if prev_url %}<a href="{{ prev_url }}"><button>â† {% trans "ì´ì „" %}</button></a>{% endif %}
        {% if next_url %}<a href="{{ next_url }}"><button>{% trans "ë‹¤ìŒ" %} â†’</button></a>{% endif %}
        {% if book.page_count and book.page_count > 1 %}
        <form id="page-jump-form" class="flex items-center ml-2">
            <input type="number" id="page-jump-input" value="{{ page_no }}" min="1" max="{{ book.page_count }}" 
                   class="w-16 text-center border border-gray-300 rounded-md shadow-sm text-sm focus:ring-blue-500 focus:border-blue-500 py-1"
                   aria-label="í˜ì´ì§€ ë²ˆí˜¸ ì…ë ¥">
            <span class="mx-2 text-gray-500 text-sm">/ {{ book.page_count }}</span>
        </form>
        {% endif %}
        </div>

        <div class="group">
        <button id="fitW" {% if status != "ready" or not html_stage_final %}disabled class="disabled:opacity-50 disabled:cursor-not-allowed"{% endif %}>{% trans "ë§ì¶¤(ê°€ë¡œ)" %}</button>
        <button id="fitH" {% if status != "ready" or not html_stage_final %}disabled class="disabled:opacity-50 disabled:cursor-not-allowed"{% endif %}>{% trans "ë§ì¶¤(ì„¸ë¡œ)" %}</button>
        <button id="zoomOut" {% if status != "ready" or not html_stage_final %}disabled class="disabled:opacity-50 disabled:cursor-not-allowed"{% endif %}>-</button>
        <span id="zoomLabel" style="color:#6b7280">100%</span>
        <button id="zoomIn" {% if status != "ready" or not html_stage_final %}disabled class="disabled:opacity-50 disabled:cursor-not-allowed"{% endif %}>+</button>
        </div>

        <div class="group">
        <label>{% trans "ë°°ê²½" %}:
            <select id="bgMode">
            <option value="auto" {% if bg_mode == "auto" %}selected{% endif %}>auto</option>
            <option value="on"   {% if bg_mode == "on" %}selected{% endif %}>on</option>
            <option value="off"  {% if bg_mode == "off" %}selected{% endif %}>off</option>
            </select>
        </label>
        <button id="search-toggle-button" title="ì±… ì•ˆì—ì„œ ê²€ìƒ‰" class="p-2 rounded-md hover:bg-gray-100 ml-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-600" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
            </svg>
        </button>
        </div>
    </div>

    {% if status != "ready" or not html_stage_final %}
        <div id="status-banner" style="padding:24px;background:#fff7ed;border:1px solid #fdba74;color:#9a3412;border-radius:12px">
        {% if status == 'failed' %}
            {% trans "ì´ í˜ì´ì§€ ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." %} (status={{ status }})
            <button id="retranslate-modal-button-inline" class="mt-2 bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-3 rounded">
                {% trans "ì´ í˜ì´ì§€ ì¬ë²ˆì—­" %}
            </button>
        {% else %}
            {% trans "ì´ í˜ì´ì§€ëŠ” ì•„ì§ ì²˜ë¦¬ ì¤‘ì´ê±°ë‚˜ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." %} (status={{ status }})
        {% endif %}
        </div>
    {% else %}
        <div class="stage" id="stage">
            <div id="pageViewport" class="page-viewport">
                <div class="page" id="page">

                    {% block content %}
                    
                    {% endblock %}

                </div>
            </div>
        </div>
    {% endif %}
    </div>

    {# -- Search Side Panel -- #}
    <div id="search-panel" class="fixed top-0 -left-96 h-full w-96 bg-white shadow-2xl z-40 transition-all duration-300 ease-in-out flex flex-col">
        <!-- Header -->
        <div class="flex justify-between items-center p-4 border-b">
            <h2 class="text-xl font-semibold">{% trans "ì±… ê²€ìƒ‰" %}</h2>
            <button id="search-panel-close" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <!-- Search Input -->
        <div class="p-4 border-b">
            <form id="search-form">
                <input type="search" id="search-input" name="q" placeholder="{% trans 'ê²€ìƒ‰ì–´ ì…ë ¥ í›„ Enter...' %}" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required minlength="2">
            </form>
        </div>
        <!-- Results -->
        <div id="search-results-container" class="flex-grow overflow-y-auto">
            <div id="search-results-list" class="divide-y"></div>
            <div id="search-message" class="p-6 text-center text-gray-500">
                {% trans "ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ê³  Enterë¥¼ ëˆ„ë¥´ì„¸ìš”." %}
            </div>
        </div>
    </div>
    <div id="search-panel-overlay" class="hidden fixed inset-0 bg-black/50 z-30"></div>

    {# -- 2. í˜ì´ì§€ ì¬ë²ˆì—­ ìš”ì²­ UI (ë²„íŠ¼ ë° ëª¨ë‹¬) -- #}
    <div class="fixed bottom-5 right-5 z-50">
        <button id="retranslate-modal-button-float" title="ì´ í˜ì´ì§€ ì¬ë²ˆì—­ ìš”ì²­" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-3 rounded-full shadow-lg flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20h5v-5M20 4h-5v5" /></svg>
        </button>
    </div>

    <div id="retranslate-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50 hidden">
      <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
          <h3 class="text-lg leading-6 font-medium text-gray-900">{% trans "í˜ì´ì§€" %} {{ page_no }} {% trans "ì¬ë²ˆì—­ ìš”ì²­" %}</h3>
          <div class="mt-2 px-7 py-3">
            <p class="text-sm text-gray-500 mb-4">{% trans "ë²ˆì—­ì´ ì–´ìƒ‰í•˜ê±°ë‚˜ ì˜ëª»ëœ ë¶€ë¶„ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”." %} ({% trans "ì˜ˆ: KipperëŠ” ì–´ë¦°ì´ì…ë‹ˆë‹¤. ì•„ì´ë§íˆ¬ë¡œ ë°”ê¿”ì£¼ì„¸ìš”." %})</p>
            <textarea id="retranslate-feedback" class="w-full h-24 p-2 border rounded" placeholder="{% trans 'í”¼ë“œë°±ì„ ì…ë ¥í•˜ì„¸ìš”... (ì„ íƒ ì‚¬í•­)' %}"></textarea>
          </div>
          <div class="items-center px-4 py-3">
            <button id="submit-retranslate" class="px-4 py-2 bg-blue-500 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">
              {% trans "ìš”ì²­í•˜ê¸°" %}
            </button>
            <button id="close-retranslate-modal" class="mt-2 px-4 py-2 bg-gray-200 text-gray-800 text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-300">
              {% trans "ì·¨ì†Œ" %}
            </button>
          </div>
        </div>
      </div>
    </div>

    {% block extra_js %}{% endblock %}
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // CSRF í† í° ê°€ì ¸ì˜¤ê¸°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // --- ì‚¬ìš©ì ë©”ë‰´ ë“œë¡­ë‹¤ìš´ ë¡œì§ ---
        const userMenuButtonPage = document.getElementById('user-menu-button-page');
        const userMenuPage = document.getElementById('user-menu-page');

        if (userMenuButtonPage && userMenuPage) {
            userMenuButtonPage.addEventListener('click', function() {
                userMenuPage.classList.toggle('hidden');
            });

            // Close the dropdown if the user clicks outside of it
            window.addEventListener('click', function(event) {
                if (!userMenuButtonPage.contains(event.target) && !userMenuPage.contains(event.target)) {
                    userMenuPage.classList.add('hidden');
                }
            });
        }

        // --- í˜ì´ì§€ ì í”„ ê¸°ëŠ¥ ë¡œì§ ---
        const pageJumpForm = document.getElementById('page-jump-form');
        const pageJumpInput = document.getElementById('page-jump-input');

        if (pageJumpForm && pageJumpInput) {
            // ì…ë ¥ í•„ë“œë¥¼ í´ë¦­í•˜ë©´ ë‚´ìš© ì „ì²´ ì„ íƒ
            pageJumpInput.addEventListener('focus', function() {
                this.select();
            });

            pageJumpForm.addEventListener('submit', function(event) {
                event.preventDefault();
                const targetPage = parseInt(pageJumpInput.value, 10);
                const maxPage = parseInt(pageJumpInput.getAttribute('max'), 10);

                if (!isNaN(targetPage) && targetPage >= 1 && targetPage <= maxPage) {
                    const currentUrl = new URL(window.location.href);
                    const pathParts = currentUrl.pathname.split('/');
                    pathParts[pathParts.length - 2] = targetPage; 
                    currentUrl.pathname = pathParts.join('/');
                    window.location.href = currentUrl.toString();
                } else {
                    alert(`{% blocktrans %}1ì—ì„œ {{ maxPage }} ì‚¬ì´ì˜ ìœ íš¨í•œ í˜ì´ì§€ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”.{% endblocktrans %}`);
                    pageJumpInput.value = {{ page_no }};
                    pageJumpInput.select();
                }
            });
        }

        // --- í˜ì´ì§€ ë²ˆì—­ ìƒíƒœ í´ë§ ë¡œì§ ---
        const bookId = {{ book.id }};
        const pageNo = {{ page_no }};
        const currentStatus = '{{ status }}';
        
        // --- í˜ì´ì§€ ë²ˆì—­ ìƒíƒœ í´ë§ ë¡œì§ ---
        if (currentStatus !== 'ready' && currentStatus !== 'failed') {
            const statusBanner = document.getElementById('status-banner');
            if (statusBanner) {
                const pollingIndicator = document.createElement('div');
                pollingIndicator.id = 'polling-indicator';
                pollingIndicator.className = 'mt-2 text-sm text-gray-600';
                pollingIndicator.textContent = '{% trans "ë²ˆì—­ ìƒíƒœë¥¼ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤... (ì™„ë£Œ ì‹œ ìë™ ìƒˆë¡œê³ ì¹¨)" %}';
                statusBanner.appendChild(pollingIndicator);
            }

            const poll = (url, interval, maxAttempts) => {
                let attempts = 0;
                const executePoll = async (resolve, reject) => {
                    if (attempts++ >= maxAttempts) {
                        return reject(new Error('Polling timed out.'));
                    }
                    try {
                        const response = await fetch(url);
                        if (!response.ok) {
                            if (response.status === 403) {
                                alert("{% trans 'ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.' %}");
                            }
                            return reject(new Error(`Status check failed with status: ${response.status}`));
                        }
                        const data = await response.json();

                        if (data.status === 'ready' || data.status === 'failed') {
                            return resolve(data.status);
                        } else {
                            setTimeout(() => executePoll(resolve, reject), interval);
                        }
                    } catch (error) {
                        return reject(error);
                    }
                };
                return new Promise(executePoll);
            };

            const statusUrl = `/books/${bookId}/pages/${pageNo}/status/?mode={{ request.GET.mode|default:'faithful' }}`;
            
            poll(statusUrl, 3000, 40) // 3ì´ˆë§ˆë‹¤, ìµœëŒ€ 2ë¶„ê°„ í™•ì¸
                .then(finalStatus => {
                    console.log(`Polling finished with status: ${finalStatus}`);
                    const indicator = document.getElementById('polling-indicator');
                    if (indicator) {
                        indicator.textContent = '{% trans "ë²ˆì—­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤..." %}';
                        indicator.className = 'mt-2 text-sm text-green-700 font-bold';
                    }
                    setTimeout(() => window.location.reload(), 500);
                })
                .catch(error => {
                    console.error('Polling failed:', error.message);
                });
        }

        // --- ê²€ìƒ‰ ê¸°ëŠ¥ ë° í•˜ì´ë¼ì´íŠ¸ ë¡œì§ ---
        if (bookId) {
            const searchToggleButton = document.getElementById('search-toggle-button');
            const searchPanel = document.getElementById('search-panel');
            const searchPanelClose = document.getElementById('search-panel-close');
            const searchPanelOverlay = document.getElementById('search-panel-overlay');
            const searchForm = document.getElementById('search-form');
            const searchInput = document.getElementById('search-input');
            const searchResultsList = document.getElementById('search-results-list');
            const searchMessage = document.getElementById('search-message');
            const contentContainer = document.querySelector('.content');

            function openSearchPanel() {
                searchPanel.classList.remove('-left-96');
                searchPanel.classList.add('left-0');
                searchPanelOverlay.classList.remove('hidden');
                searchInput.focus();
            }

            function closeSearchPanel() {
                searchPanel.classList.add('-left-96');
                searchPanel.classList.remove('left-0');
                searchPanelOverlay.classList.add('hidden');
            }

            searchToggleButton.addEventListener('click', openSearchPanel);
            searchPanelClose.addEventListener('click', closeSearchPanel);
            searchPanelOverlay.addEventListener('click', closeSearchPanel);

            searchForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    searchMessage.textContent = '{% trans "ê²€ìƒ‰ì–´ëŠ” 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”." %}';
                    return;
                }

                searchResultsList.innerHTML = '';
                searchMessage.innerHTML = '<div class="animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mt-8"></div>';
                searchMessage.classList.remove('hidden');

                try {
                    const response = await fetch(`/books/${bookId}/search/?q=${encodeURIComponent(query)}`);
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error || '{% trans "ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." %}');
                    }
                    const results = await response.json();

                    if (results.length === 0) {
                        searchMessage.textContent = `{% blocktrans %}'${query}'ì— ëŒ€í•œ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.{% endblocktrans %}`;
                    } else {
                        searchMessage.classList.add('hidden');
                        results.forEach(result => {
                            const resultEl = document.createElement('a');
                            const currentUrlParams = new URLSearchParams(window.location.search);
                            currentUrlParams.set('highlight', query);
                            resultEl.href = `/books/${bookId}/pages/${result.page_no}/?${currentUrlParams.toString()}`;
                            resultEl.className = 'block p-4 hover:bg-gray-50 cursor-pointer';
                            resultEl.innerHTML = `<div class="font-bold text-blue-600">Page ${result.page_no}</div><div class="text-sm text-gray-600 mt-1">${result.snippet}</div>`;
                            searchResultsList.appendChild(resultEl);
                        });
                    }
                } catch (error) {
                    searchMessage.textContent = error.message;
                }
            });

            // --- Highlight on Page Load ---
            function applyHighlight() {
                const params = new URLSearchParams(window.location.search);
                const highlightQuery = params.get('highlight');
                if (!highlightQuery || !contentContainer) return;

                const re = new RegExp(`(${highlightQuery.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')})`, 'gi');
                const walker = document.createTreeWalker(contentContainer, NodeFilter.SHOW_TEXT);
                const nodes = [];
                while(walker.nextNode()) if(re.test(walker.currentNode.nodeValue)) nodes.push(walker.currentNode);
                nodes.forEach(node => {
                    const newHtml = node.nodeValue.replace(re, '<mark class="bg-yellow-300 px-1 rounded-sm">$1</mark>');
                    node.parentNode.replaceChild(document.createRange().createContextualFragment(newHtml), node);
                });
            }
            applyHighlight();
        }

        // ì±… ì „ì²´ ì¬ì‹œë„ ë²„íŠ¼ ë¡œì§
        const retryBookButton = document.getElementById('retry-book-button');
        if (retryBookButton) {
            retryBookButton.addEventListener('click', async () => {
                retryBookButton.textContent = '{% trans "ìš”ì²­ ì¤‘..." %}';
                retryBookButton.disabled = true;
                try {
                    const response = await fetch(`/books/{{ book.id }}/retry/`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                    });
                    const data = await response.json();
                    if (!response.ok && response.status === 403 && data.detail === "Authentication credentials were not provided.") {
                        alert('{% trans "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." %}');
                        window.location.href = "{% url 'mybook:login_page' %}";
                        return;
                    }
                    alert(data.message || data.error);
                    if (response.ok) window.location.reload();
                } catch (e) {
                    alert('{% trans "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." %}');
                } finally {
                    retryBookButton.textContent = '{% trans "ì‹¤íŒ¨í•œ ì‘ì—… ì „ì²´ ì¬ì‹œë„" %}';
                    retryBookButton.disabled = false;
                }
            });
        }

        // ì¬ë²ˆì—­ ëª¨ë‹¬ ë¡œì§
        const modal = document.getElementById('retranslate-modal');
        const openModalButtons = document.querySelectorAll('#retranslate-modal-button-float, #retranslate-modal-button-inline');
        const closeModalBtn = document.getElementById('close-retranslate-modal');
        const submitBtn = document.getElementById('submit-retranslate');

        openModalButtons.forEach(btn => btn.onclick = () => modal.style.display = 'block');
        closeModalBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == modal) modal.style.display = 'none';
        };

        submitBtn.addEventListener('click', async () => {
            const feedback = document.getElementById('retranslate-feedback').value;

            submitBtn.textContent = '{% trans "ìš”ì²­ ì¤‘..." %}';
            submitBtn.disabled = true;

            try {
                const response = await fetch('{% url "mybook:retranslate_page" book_id=book.id page_no=page_no %}', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: feedback || "Retranslate this page." }) // í”¼ë“œë°±ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ë©”ì‹œì§€
                });
                const data = await response.json();
                if (!response.ok && response.status === 403 && data.detail === "Authentication credentials were not provided.") {
                    alert('{% trans "ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤." %}');
                    window.location.href = "{% url 'mybook:login_page' %}";
                    return;
                }
                alert(data.message || data.error);
                if (response.ok) {
                    modal.style.display = 'none';
                    setTimeout(() => window.location.reload(), 1500);
                }
            } catch (e) {
                alert('{% trans "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤." %}');
            } finally {
                submitBtn.textContent = '{% trans "ìš”ì²­í•˜ê¸°" %}';
                submitBtn.disabled = false;
            }
        });
    });
    </script>
</body>
</html>
